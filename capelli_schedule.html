<!DOCTYPE html>
<html>

  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js">
    </script>

    <script src="testfile.js" ></script>

    <script type="text/javascript">
      $(document).ready(function(){
        if (typeof getTestRequest == 'undefined') {
          $('#btnFetchFromMock').hide()
          fetchGamesFromSheet();
        }
      });
    </script>

    <script type="text/javascript">
     
      function populateTableFromMockData(){
        var response = getTestRequest();
        console.log(response);
        populateTableWithPractices(response.values);
      }
      
      function fetchGamesFromSheet() {
        let spreadsheetId="1peqZ_mflm9mLBVnsDzMsSDGLTq1mmpy4Qc0cpKVVUkc"
        let range = "capelli_schedule";
        let apiKey = "AIzaSyBvV43w6Zu3mpvKhTbn-Flh5jlc-7uzL5Y";
        let url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
        
        $.ajax({
          type: "GET",
          url: url,
          cache: false,
          data: "",
          success: function(response) {
            console.log(response)
            populateTableWithPractices(response.values);
          }
        });
      }

      function populateTableWithPractices(games){
        var converted = convert2DArrayToJson(games);

        // if (!$('#ckbShowPast').is(":checked")){
        //   converted = converted.filter(v => new Date(v.date).getTime() >= new Date().getTime());
        // }

        // const homeGames = converted.filter(v => v.homeGame === "HOME");
        // console.log("HOME GAMES", homeGames)
        var practicesGroupedByDate = groupBy(converted, 'date');
        console.log("practicesGroupedByDate", practicesGroupedByDate);
        // console.log("practicesGroupedByDate_2", practicesGroupedByDate_2);
        
        $('#testTbl').html(""); // clear out existing
          buildPracticeTable(practicesGroupedByDate);

        // for (var key in practicesGroupedByDate){
        //   buildPracticeTable(practicesGroupedByDate[key]);
        // }
      }

      function groupBy(data, groupByAttribute){
          var groupedBy = data.reduce(function (obj, item) {
            obj[item[groupByAttribute]] = obj[item[groupByAttribute]] || [];
            obj[item[groupByAttribute]].push(item);
            return obj;
        }, {});
        return groupedBy;
      }


      function convert2DArrayToJson(json){
        // vacate headers/keys
        let data = json;
        let keys = data.shift()
        console.log("Header keys:", keys)
        // create JSON objects from Array
        let result = data.map(data =>
            Object.assign({}, ...data.map((x, i) => ({ [keys[i]]: x })))
        );
        console.log("convert2DArrayToJson", result);
        return result
      }

      function buildPracticeTable(practicesByDate){
        // console.log("practicesByDate", practicesByDate)
        //already grouped by date, now group by time then 
        // practicesByDate.sort(function (a, b) {
        //   if(! a.time)
        //     return new Date('1970/01/01 ' + a.time) - new Date('1970/01/01 ' + b.time);
        // });

        var groupByDate = $('<div/>'),
          seperator = $('<div/>'),
          table = $('<table/>'),
          table_head = $('<thead/>'),
          head_row = $('<tr/>'),
          table_body = $('<tbody/>'),
          body_row = [];

        // groupByDate.append('<div class="groupedByDate">' + practicesByDate[0].date + "<div/>");
        
        // var gamesGroupedByTime = groupBy(practicesByDate, 'time');        
        // if("" in gamesGroupedByTime){
        //    var notScheduledGames = "";
        //    gamesGroupedByTime[""].forEach( game => {
        //        notScheduledGames += `<label>(#${game.matchNum}) ${game.freeholdTeam}, </label>`
        //      });
        //   delete gamesGroupedByTime[""];
        //   groupByDate.append('<div class="gamesNotScheduled"><b>Games Not Scheduled yet:</b> ' + notScheduledGames + "<div/>");          
        // }
        // console.log("gamesGroupedByTime ", gamesGroupedByTime);  
          
        // 9v9	9v9	9v9	9v9		7v7	7v7	7v7	7v7		11v11	11v11		7v7	7v7
        // OP4A	OP4B	OP4C	OP4D		OP6A	OP6B	OP6C	OP6D		OP5	OP5		JM5	JM6
        // var fields = ["OP4A","OP4B","OP4C","OP4D","OP6A","OP6B","OP6C","OP6D","OP5","OP5","JM5","JM6"];
        // var fields = ["OP4","OP6B","OP6C","OP6D","OP5","OP5","JM5","JM6"];
        var fields = ["JM1", "JM2", "JM3","JM4","JM5","JM6"];

        // search for any fields not at JM (typically we only have games at JM)
        // var extraFields = [];
        // for (g of practicesByDate){
        //   if(g.fieldNum && g.fieldNum != "" && !(fields.includes(g.fieldNum)) && !(extraFields.includes(g.fieldNum))){
        //     extraFields.push(g.fieldNum);
        //   }
        // }
        // if(extraFields.length > 0)
        //   fields = fields.concat(extraFields.sort());

        // head_row.append(`<th>Times</th>`); // vertial column
        // for (f of fields){
        //   head_row.append(`<th>${f}</th>`);
        // }

        var practicesTables = $('<div/>');
        for ([key, p] of Object.entries(practicesByDate)){
            var byDateDiv = $(`<div class="dayWrapper"> </div>`)
            byDateDiv.append(`<div class="dateHeader">${key}</div>`);
            for (t of ['5:30-7:00', '7:00-8:30']){
                byDateDiv.append(
                    `<table>
                        <tr><td class="practiceTimeHeader" colspan="2">${t}</td></tr>
                        <tr>
                            ${createTD(p.find(v => v.time == t && v.fieldNum == "Field_6A"), "6A")}
                            ${createTD(p.find(v => v.time == t && v.fieldNum == "Field_6C"), "6C")}
                        </tr>
                        <tr>
                            ${createTD(p.find(v => v.time == t && v.fieldNum == "Field_6B"), "6B")}
                            ${createTD(p.find(v => v.time == t && v.fieldNum == "Field_6D"), "6D")}
                        </tr>
                    </table>`);
            }
            practicesTables.append(byDateDiv);
        }
        
        $('#testTbl').append(practicesTables);
      }

      function createTD(practice, field){
        if (!practice) return "<td>NULL</td>";

        // console.log("practice", practice)
        var text = practice.Status == "UnReserved" ? field : practice.freeholdTeam;
        var id = (practice.dropDownDisplay).replaceAll(" :: ", "__");
        return `<td id="${id}" class="tbl_td ${practice.Status}">${text}</td>`;
      }
        
      function showOldGamesCkbChange(e){
        const {checked} = e.target;

        if (typeof getTestRequest == 'undefined') {
          fetchGamesFromSheet();
        }
        else{
          populateTableFromMockData()
        }
      }

    </script>
    <style>
      .pageTitle {
        text-align: center;
      }
      .pageControls{
        text-align: center;
      }
      
      #messageDiv{
        text-align: center;
      }

      .groupedByDate   {
        background-color: #9d9e9f;
        font-size: larger;
        font-weight: bold;
        margin-top: 10px;
        padding: 5px;
      }

      .gamesNotScheduled   {background-color: #ffcc00;}
      /* tr {padding-left: 15px;padding-right: 15px;} */

      .dateHeader{
        background-color: #9d9e9f;
      }
      table {
        border-collapse: collapse;
        text-align: center;
      }
      th, td {
        border: 1px solid black;
        padding-left: 15px;padding-right: 15px;
      }
      th {font-size: large;}
      .tbl_td{
        min-width: 100px;
      }
    </style>
    
  </head>

  <body>
    <form>
      <div class="pageTitle">
        <h1>
         Freehold Soccer Game Schedule
        </h1>
      </div>
      <div class="pageControls">
        <input id="btnFetchFromSheet" type="button" value="Refresh" onclick="fetchGamesFromSheet();" />
        <input id="btnFetchFromMock" type="button" value="Load From Test File" onclick="populateTableFromMockData();" />
        <input type="checkbox" id="ckbShowPast" onchange="showOldGamesCkbChange(event)"/>
        <label for="ckbMessage">Show games in the past</label>
      </div>
      <div id="messageDiv">
        Hover over the game  to see game details
      </div>
      <br />
      <br />
      <div id="testTbl"></div>
      <br />
    </form>
  </body>

</html>

