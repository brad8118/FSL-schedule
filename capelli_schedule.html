<!DOCTYPE html>
<html>

  <head>
    <!-- <meta name="referrer" content="No-referrer"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js">
    </script>

    <script src="capelli_mock_2.js" ></script>

    <script type="text/javascript">
      $(document).ready(function(){
        populateTable()
      });
    </script>

    <script type="text/javascript">

      function populateTable(){
        if (typeof getTestRequest == 'undefined') {
          $('#btnFetchFromMock').hide()
          fetchGamesFromSheet();
        }
        else{
          populateTableFromMockData();
        }
      }
     
      function populateTableFromMockData(){
        var response = getTestRequest();
        console.log(response);
        populateTableWithPractices(response.values);
      }
      
      function fetchGamesFromSheet() {
        let spreadsheetId="1peqZ_mflm9mLBVnsDzMsSDGLTq1mmpy4Qc0cpKVVUkc"
        let range = "capelli_schedule";
        let apiKey = "AIzaSyBvV43w6Zu3mpvKhTbn-Flh5jlc-7uzL5Y";
        let url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
        
        $.ajax({
          type: "GET",
          url: url,
          cache: false,
          data: "",
          success: function(response) {
            // console.log(response)
            populateTableWithPractices(response.values);
          }
        });
      }

      window.googleDocCallback = function () { return true; };

      function UserAction() {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                console.log(this.responseText)
                alert(this.responseText);
              }
          };
          // url = "https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/formResponse?usp=pp_url&entry.1361341806=teamName&entry.34932603=Capelli+::+2/27/2023+::+Field_6B+::+5:30-7:00&entry.854855789=2023-03-08&entry.215078193=Weekday+Early+Game+(@+5:45PM+%2B/-)&entry.1208106386=NOTES+with+spaces&entry.1434428034=brad81182@gmail.com"
          // url += "&callback=googleDocCallback";

          url = "https://reverse-cors.herokuapp.com/https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/formResponse?usp=pp_url&entry.1361341806=brad-test-cors&entry.34932603=Capelli+::+2/27/2023+::+Field_6A+::+7:00-8:30&entry.854855789=2023-03-15&entry.215078193=Weekday+Early+Game+(@+5:45PM+%2B/-)&entry.280905652=2023-03-15&entry.1208106386=please+work&entry.1434428034=brad8118@gmail.com";
          
          
          xhttp.open("GET", url, true);
          // xhttp.setRequestHeader("Access-Control-Allow-Origin", '*');
          xhttp.send();
      }

      /**
       * set request to spread sheet responses to request or cancel practice
       **/
      function sendRequestToGoogleSheets(dropDownDisplay, teamName, practice_game, email){

        // Object.defineProperty(document, "referrer", {get : function(){ return "https://6319365"; }});

        return UserAction()

        let spreadsheetId="1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ";
        let a_teamname = teamName.trim().replaceAll(" ", "+"); //'Wildfire';
        let a_dropDownDisplay = dropDownDisplay.trim().replaceAll("__", " :: ").replaceAll(" ", "+")//"Capelli+::+2/27/2023+::+Field_6A+::+7:30-8:30";
        let a_practice_game = practice_game.trim().replaceAll(" ", "+"); //"Practice"
        let a_contact = email.trim().replaceAll(" ", "+");; // "brad8118@gmail.com"
        let a_1st_date = dropDownDisplay.trim().split("__")[1]; //Capelli__3/3/2023__Field_6C__7:00-8:30;
        let a_1st_time = "Weekday+Early+Game+(@+5:45PM+%2B/-)";
        // let url = `
        //     https://docs.google.com/forms/d/e/${spreadsheetId}/formResponse?usp=pp_url
        //     &entry.1361341806=${a_teamname}
        //     &entry.34932603=${a_dropDownDisplay}
        //     &entry.854855789=${a_1st_date}
        //     &entry.215078193=${a_1st_time}
        //     &entry.1208106386=${a_practice_game}
        //     &entry.1434428034=${a_contact}`

        let dataToPost = new FormData(); //formdata API
        dataToPost.append("entry.294341084", a_teamname);
        dataToPost.append("entry.34932603", a_dropDownDisplay);
        dataToPost.append("entry.854855789", a_1st_date);
        dataToPost.append("entry.215078193", a_1st_time);
        dataToPost.append("entry.1208106386", a_practice_game);
        dataToPost.append("entry.1434428034", a_contact);

        fetch("https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/formResponse",{
        method: "POST",
        mode: "no-cors",
        header:{
            'Content-Type': 'application/json'
            },
        body: dataToPost
        })
        .then(data=>{
            console.log(data);
            alert("Form Submitted");
        })
        .catch(err=>console.error(err)); //promise based


        return


        $('input[name="entry.1361341806"]').val(a_teamname);
        $('input[name="entry.34932603"]').val(a_dropDownDisplay);
        $('input[name="entry.854855789"]').val(a_1st_date);
        $('input[name="entry.215078193"]').val(a_1st_time);
        $('input[name="entry.1208106386"]').val(a_practice_game);
        $('input[name="entry.1434428034"]').val(a_contact);

        // $('#my-form').submit(function(e) {
            //prevent the form from submiting so we can post to the google form
          // e.preventDefault();
          //AJAX request
          $.ajax({
            url: 'https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/formResponse',     //The public Google Form url, but replace /view with /formResponse
            data: $('#my-form').serialize(), //Nifty jquery function that gets all the input data 
            type: 'POST', //tells ajax to post the data to the url
            dataType: "json", //the standard data type for most ajax requests
            statusCode: { //the status code from the POST request
              0: function(data) { //0 is when Google gives a CORS error, don't worry it went through
                //success
                $('#form-success').text('hooray! 0');
              }, 
              200: function(data) {//200 is a success code. it went through!
                //success
                $('#form-success').text('hooray! 200');
              },
              403: function(data) {//403 is when something went wrong and the submission didn't go through
                //error
                alert('Oh no! something went wrong. we should check our code to make sure everything matches with Google');
              }
            }  
          });
        // });                     

        return 

        /////
        //https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/formResponse?usp=pp_url&entry.1361341806=brad_test&entry.34932603=Capelli+::+2/27/2023+::+Field_6A+::+7:00-8:30&entry.854855789=2023-03-10&entry.215078193=Weekday+Early+Game+(@+5:45PM+%2B/-)&entry.1208106386=tes+tes&entry.1434428034=brad

        let url = `https://docs.google.com/forms/d/e/${spreadsheetId}/formResponse?usp=pp_url&entry.1361341806=${a_teamname}&entry.34932603=${a_dropDownDisplay}&entry.854855789=${a_1st_date}&entry.215078193=${a_1st_time}&entry.1208106386=${a_practice_game}&entry.1434428034=${a_contact}`
        //https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/formResponse?entry.1361341806=wildfire&entry.34932603=Capelli+::+2/27/2023+::+Field_6B+::+5:30-7:00&entry.854855789=2/27/2023&entry.215078193=Weekday+Early+Game+(@+5:45PM+%2B/-)&entry.1208106386=test&entry.1434428034=brad
        //https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/formResponse?usp=pp_url&entry.1361341806=teamName&entry.34932603=Capelli+::+2/27/2023+::+Field_6B+::+5:30-7:00&entry.854855789=2023-03-08&entry.215078193=Weekday+Early+Game+(@+5:45PM+%2B/-)&entry.1208106386=NOTES+with+spaces&entry.1434428034=brad8118@gmail.com
        url = "https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/formResponse?usp=pp_url&entry.1361341806=teamName&entry.34932603=Capelli+::+2/27/2023+::+Field_6B+::+5:30-7:00&entry.854855789=2023-03-08&entry.215078193=Weekday+Early+Game+(@+5:45PM+%2B/-)&entry.1208106386=NOTES+with+spaces&entry.1434428034=brad81182@gmail.com"
        
        // url += "&callback=googleDocCallback";

        url = "https://reverse-cors.herokuapp.com/https://docs.google.com/forms/d/e/1FAIpQLScLOZl2sY_u0UbVVmojFnC4yHKMVSXM9272IgFSqxIuo99frQ/viewform?usp=pp_url&entry.1361341806=brad-test-cors&entry.34932603=Capelli+::+2/27/2023+::+Field_6A+::+7:00-8:30&entry.854855789=2023-03-15&entry.215078193=Weekday+Early+Game+(@+5:45PM+%2B/-)&entry.280905652=2023-03-15&entry.1208106386=please+work&entry.1434428034=brad8118@gmail.com";
        console.log("url", url)

        $.ajax({
          type: "GET",
          url: url,
          beforeSend: function(jqXHR, settings) {
            // jqXHR.setRequestHeader('x-access-token', undefined); // the header to remove
            // jqXHR.setRequestHeader("Access-Control-Allow-Origin", '*'); // the header to remove
          },
          // beforeSend: function(request) {
          //   request.setRequestHeader("Access-Control-Allow-Origin", '*');
          //   request.setRequestHeader("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
          // },
          // crossDomain: true,
          // cache: false,
          // data: "",
          // dataType: 'jsonp',

          statusCode: { //the status code from the POST request
            0: function(data) { //0 is when Google gives a CORS error, don't worry it went through
              //success
              $('#form-success').text('hooray!');
            }, 
            200: function(data) {//200 is a success code. it went through!
              //success
              $('#form-success').text('hooray!');
            },
            403: function(data) {//403 is when something went wrong and the submission didn't go through
              //error
              alert('Oh no! something went wrong. we should check our code to make sure everything matches with Google');
            }
          },

          // success: function(response) {
          //   console.log(response)
          //   populateTable();
          // }
        });
      }

      function populateTableWithPractices(games){
        var converted = convert2DArrayToJson(games);

        // if (!$('#ckbShowPast').is(":checked")){
        //   converted = converted.filter(v => new Date(v.date).getTime() >= new Date().getTime());
        // }

        // console.log("HOME GAMES", homeGames)
        var practicesGroupedByDate = groupBy(converted, 'date');
        console.log("practicesGroupedByDate", practicesGroupedByDate);
        // console.log("practicesGroupedByDate_2", practicesGroupedByDate_2);
        
        $('#testTbl').html(""); // clear out existing
          buildPracticeTable(practicesGroupedByDate);
      }

      function groupBy(data, groupByAttribute){
          var groupedBy = data.reduce(function (obj, item) {
            obj[item[groupByAttribute]] = obj[item[groupByAttribute]] || [];
            obj[item[groupByAttribute]].push(item);
            return obj;
        }, {});
        return groupedBy;
      }


      function convert2DArrayToJson(json){
        // vacate headers/keys
        let data = json;
        let keys = data.shift()
        console.log("Header keys:", keys)
        // create JSON objects from Array
        let result = data.map(data =>
            Object.assign({}, ...data.map((x, i) => ({ [keys[i]]: x })))
        );
        console.log("convert2DArrayToJson", result);
        return result
      }

      function buildPracticeTable(practicesByDate){
        // console.log("practicesByDate", practicesByDate)
        var practicesTables = $('<div/>');
        for ([key, p] of Object.entries(practicesByDate)){
            var byDateDiv = $(`<table class="dayWrapper"> </table>`)
            byDateDiv.append(`<tr><td class="dateHeader" colspan="2">${key}</td></tr>`);
           
            for (t of ['5:30-7:00', '7:00-8:30']){
                byDateDiv.append(
                    ` <tr><td class="practiceTimeHeader" colspan="2">${t}</td></tr>
                      <tr>
                          ${createTD(p.find(v => v.time == t && v.fieldNum == "Field_6A"), "6A")}
                          ${createTD(p.find(v => v.time == t && v.fieldNum == "Field_6C"), "6C")}
                      </tr>
                      <tr>
                          ${createTD(p.find(v => v.time == t && v.fieldNum == "Field_6B"), "6B")}
                          ${createTD(p.find(v => v.time == t && v.fieldNum == "Field_6D"), "6D")}
                      </tr>`);
            }
            practicesTables.append(byDateDiv);
        }
        
        $('#testTbl').append(practicesTables);
        
        $(".UnReserved").click(function(){
          $(this).toggleClass("selected");
          populateSelectionLists()
        });

        $(".Booked").click(function(){
          $(this).toggleClass("canceling");
          populateSelectionLists()
        });
      }

      /**
       * When table cell is click show which items are selected
       **/
      function populateSelectionLists(){
          $("#practicesToRequest").html(""); // clear out existing
          $("#practicesToCancel").html(""); // clear out existing
          $('#btnSubmit').hide();
          $('#lblErrorSumit').text("")

          //add to requested
          if ($(".selected").length){
            $('#btnSubmit').show();
            $("#practicesToRequest").append(`<tr><th class="selectedCellsDisplayed">Practices to request:</th><tr>`);                        
            $(".selected").each(function(index) {
              $("#practicesToRequest").append(`<tr><td>${$(this)[0].id}</tr></td>`);
            });
          }

          //canceling existing requested
          if ($(".canceling").length){
            $('#btnSubmit').show();
            $("#practicesToCancel").append(`<tr><th class="selectedCellsDisplayed">Canceling requested practice:</th><tr>`);                        
            $(".canceling").each(function(index) {
              $("#practicesToCancel").append(`<tr><td>${$(this)[0].id}</tr></td>`);
            });
          }
      }

      function createTD(practice, field){
        if (!practice) return "<td>NULL</td>";

        // console.log("practice", practice)
        var text = practice.Status == "UnReserved" ? field : practice.freeholdTeam;
        var id = (practice.dropDownDisplay).replaceAll(" :: ", "__");
        return `<td id="${id}" class="tbl_td ${practice.Status}">${text}</td>`;
      }
        
      function showOldGamesCkbChange(e){
        const {checked} = e.target;
        populateTable();
      }

      // <div><label>Team Name</label> <input id="tbxTeamName" type="text" /></div>
      //   <div><label>Game or Pratice (notes)</label> <input id="tbxGamePractice" type="text" /></div>
      //   <div><label>Email (seperated by commas)</label> <input id="email" type="text" /></div>

      /**
       * 
       **/
      function submitSelectedPractices(){
        let teamName = $('#tbxTeamName').val()
        let gamePractice = $('#tbxGamePractice').val()
        let email = $('#email').val()

        $(".selected").each(function(index) {
          $("#practicesToRequest").append(`<tr><td>${$(this)[0].id}</tr></td>`);
          let dropDownDisplay = $(this)[0].id;          
          sendRequestToGoogleSheets(dropDownDisplay, teamName, gamePractice, email);
        });
      }
    </script>
    <style>
      .pageTitle {
        text-align: center;
      }
      .pageControls{
        text-align: center;
      }
      
      #messageDiv{
        text-align: center;
      }

      .groupedByDate   {
        background-color: #9d9e9f;
        font-size: larger;
        font-weight: bold;
        margin-top: 10px;
        padding: 5px;
      }

      .gamesNotScheduled   {background-color: #ffcc00;}
      /* tr {padding-left: 15px;padding-right: 15px;} */

      .dateHeader{
        background-color: #9d9e9f;
      }
      table {
        border-collapse: collapse;
        text-align: center;
      }
      th, td {
        border: 1px solid black;
        padding-left: 15px;padding-right: 15px;
      }

      th {font-size: large;}

      .tbl_td{
        min-width: 100px;
      }

      .dayWrapper{
        float:left;
        position: relative;
        margin-bottom: 10px;
      }

      .Booked{
        background-color: darkseagreen;
      }

      .Requested{
        background-color: goldenrod;
      }

      .selected{
        background-color: rgb(255, 217, 0);
      }

      #divInputs {
        /* width: 100%; */
        text-align: center;
        /* border: solid 1px black; */
        position: relative;
        float: left;
      }

      #practicesToRequest, #practicesToCancel{
        margin-right: 10px;
        position: relative;
        float: left;
      }


      #divInputs > div{
        position: relative;
        float: left;
        padding-right: 20px;
      }

      #divInputs label{
        font-weight: bolder;
      }

      #groupingOfSelectedCells{
        position: relative;
        float: left;
        width: 100%;
        padding:10px;
      }

      .selectedCellsDisplayed{
        /* width: 100%; */
        /* text-align: center; */
        font-weight: bold;
      }
    </style>
    
  </head>

  <body>
    <form>
      <div class="pageTitle">
        <h1>
         Capelli Schedule
        </h1>
      </div>
      <div class="pageControls">
        <input id="btnFetchFromSheet" type="button" value="Refresh" onclick="fetchGamesFromSheet();" />
        <input id="btnFetchFromMock" type="button" value="Load From Test File" onclick="populateTableFromMockData();" />
        <input type="checkbox" id="ckbShowPast" onchange="showOldGamesCkbChange(event)"/>
        <label for="ckbMessage">Show practices in the past</label>
      </div>
      <div id="messageDiv">
        Hover over the game to see game details
      </div>
      <div id="divInputs">
        <div><label>Team Name</label> <input id="tbxTeamName" type="text" /></div>
        <div><label>Game or Pratice (notes)</label> <input id="tbxGamePractice" type="text" /></div>
        <div><label>Email (seperated by commas)</label> <input id="email" type="text" /></div>
      </div>
      <id id="formDiv">
        <form id="my-form">
          <input name="entry.1361341806" type="text" required/> <!-- a_teamname -->
          <input name="entry.34932603" type="text" required/> <!-- a_dropDownDisplay -->
          <input name="entry.854855789" type="text" required/> <!-- a_1st_date -->
          <input name="entry.215078193" type="text" required/> <!-- a_1st_time -->
          <input name="entry.1208106386" type="text" required/> <!-- a_practice_game -->
          <input name="entry.1434428034" type="text" required/> <!-- a_contact -->
          <input type="submit" />
        </form>
        <div id="form-success">HI</div>
      </id>
      <div id="groupingOfSelectedCells">
        <table id="practicesToRequest">
        </table>
        <table id="practicesToCancel">
        </table>
        <button id="btnSubmit" hidden="hidden" type="button" onclick="submitSelectedPractices()">Request / Cancel Practices</button>
        <label id="lblErrorSumit"></label>
      </div>
      <br />
      <br />
      <div id="testTbl"></div>
      <br />
    </form>
  </body>
</html>

