<!DOCTYPE html>
<html>

  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js">
    </script>

    <script src="mock_league_schedule.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/0.0.3/ical.min.js" ></script>


    <script type="text/javascript">
      $(document).ready(function(){
        if (typeof getTestRequest == 'undefined') {
          $('#btnFetchFromMock').hide()
          fetchDataOnLoad();
        }
      });
    </script>

    <script type="text/javascript">

      const dayOfWeekLookup = ["Sunday",  "Monday", "Tuesday", "Wednesday", "Thursday", "Friday",  "Saturday"];

      function populateTableFromMockData(){
        var response = getTestRequest();
        console.log(response);
        populateTableWithGames(response.values,[]);
      }

      function fetchDataOnLoad(){
        $.when(getAjax_fetchGamesFromSheet(), getAjax_getCameraSchedule()).done(function(games, camera){         
          populateTableWithGames(games[0].values, camera[0]);
        });   
      }

      
      function getAjax_fetchGamesFromSheet() {
        let spreadsheetId="1peqZ_mflm9mLBVnsDzMsSDGLTq1mmpy4Qc0cpKVVUkc"
        let range = "league_schedule";
        let apiKey = "AIzaSyBvV43w6Zu3mpvKhTbn-Flh5jlc-7uzL5Y";
        let url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
        
        return $.ajax({
          type: "GET",
          url: url,
          cache: false,
          data: "",
          success: function(response) {
            console.log(response)
            // populateTableWithGames(response.values);
          }
        });
      }
       

      function getAjax_getCameraSchedule(){
        return $.ajax({
          type: "GET",
          url: 'https://reverse-cors.herokuapp.com/http://ical-cdn.teamsnap.com/team_schedule/c63039e7-4db3-42ff-ab1c-c1b26b730995.ics',
          cache: false,
          data: "",
          success: function(response) {
            // console.log(response)
          }
        });
      }

      function convertCameraScheduleResponse(response){
        var jcalData = ICAL.parse(response);
        let cameraScheduled = []
        for(v of jcalData[1][2]){
          if(v[0] == 'vevent'){
            let vevent = v[1]; //vevent
            for(ve of vevent){
              if(ve[0] == "description" && ve[3].includes("VEO")){
                let camera={};
                if(ve[3].toLowerCase().includes("veo 1"))
                  camera['camera']="VEO 1";
                else if(ve[3].toLowerCase().includes("veo 2"))
                  camera['camera']="VEO 2";
                else if(ve[3].toLowerCase().includes("veo 3"))
                  camera['camera']="VEO 3";
                
                for(i of vevent){
                  if(i[0] == 'dtstart')
                    camera['start'] = i[3];
                  else if(i[0] == 'description')
                    camera['description'] = i[3];
                  else if(i[0] == 'location')
                    camera['field'] = i[3];                  
                }                  

                cameraScheduled.push(camera)
              }
            }
          }              
        }
        return cameraScheduled
      }

      function populateTableWithGames(games, camera){
        let cameraSchedule = convertCameraScheduleResponse(camera);
        var converted = convert2DArrayToJson(games);
        var ckbShowPastGames = $("#ckbShowPastGames");

        if (!$('#ckbShowPastGames').is(":checked")){
          converted = converted.filter(function (v) {
            let now = new Date();
            now.setHours(0,0,0,0);
            return new Date(v.date).getTime() >= now.getTime();
          });
        }

        const homeGames = converted.filter(v => v.homeGame === "HOME");
        homeGames.sort((a, b) => (new Date(a.date) - new Date(b.date) ))
        // console.log("HOME GAMES", homeGames)

        var gamesGroupedByDate = groupBy(homeGames,'date');
        // console.log("gamesGroupedByDate", gamesGroupedByDate);
        
        $('#testTbl').html(""); // clear out existing
        for (var key in gamesGroupedByDate){
          buildGameTable(gamesGroupedByDate[key], cameraSchedule);
        }
      }

      function groupBy(data, groupByAttribute){
          var groupedBy = data.reduce(function (obj, item) {
            obj[item[groupByAttribute]] = obj[item[groupByAttribute]] || [];
            obj[item[groupByAttribute]].push(item);
            return obj;
        }, {});
        return groupedBy;
      }


      function convert2DArrayToJson(json){
        // vacate headers/keys
        let data = json;
        let keys = data.shift()
        console.log("Header keys:", keys)
        // create JSON objects from Array
        let result = data.map(data =>
            Object.assign({}, ...data.map((x, i) => ({ [keys[i]]: x })))
        );
        console.log("convert2DArrayToJson", result);
        return result
      }

      function buildGameTable(gamesByDate, cameraSchedule){
        // console.log("gamesByDate", gamesByDate)
        // console.log(cameraSchedule)
        //already grouped by date, now order by time  
        gamesByDate.sort(function (a, b) {  
          return new Date('1970/01/01 ' + a.time).getTime() - new Date('1970/01/01 ' + b.time).getTime();
        });

        var groupByDate = $('<div/>'),
          seperator = $('<div/>'),
          table = $('<table/>'),
          table_head = $('<thead/>'),
          head_row = $('<tr/>'),
          table_body = $('<tbody/>'),
          body_row = [];

        // let formattedDay =  `${dayOfWeekLookup[new Date(gamesByDate[0].date).getDay()]}, ${gamesByDate[0].date}`
        // let formattedDay =  `${new Date(gamesByDate[0].date)}`
        let dayOfWeek = dayOfWeekLookup[new Date(gamesByDate[0].date).getDay()]
        let dayStr = new Date(gamesByDate[0].date).toLocaleString().split(',')[0];   

        groupByDate.append(`<div class="groupedByDate">${dayOfWeek}, ${dayStr}<div/>`);
        
        var gamesGroupedByTime = groupBy(gamesByDate, 'time');        
        if("" in gamesGroupedByTime){
           var notScheduledGames = "";
           gamesGroupedByTime[""].forEach( game => {
               notScheduledGames += `<label>(#${game.matchNum}) ${game.freeholdTeam}, </label>`
             });
          delete gamesGroupedByTime[""];
          groupByDate.append('<div class="gamesNotScheduled"><b>Games Not Scheduled yet:</b> ' + notScheduledGames + "<div/>");          
        }
        // console.log("gamesGroupedByTime ", gamesGroupedByTime);  
          
        // 9v9	9v9	9v9	9v9		7v7	7v7	7v7	7v7		11v11	11v11		7v7	7v7
        // OP4A	OP4B	OP4C	OP4D		OP6A	OP6B	OP6C	OP6D		OP5	OP5		JM5	JM6
        // var fields = ["OP4A","OP4B","OP4C","OP4D","OP6A","OP6B","OP6C","OP6D","OP5","OP5","JM5","JM6"];
        // var fields = ["OP4","OP6B","OP6C","OP6D","OP5","OP5","JM5","JM6"];
        var fields = ["JM1", "JM2", "JM3","JM4","JM5","JM6"];

        // search for any fields not at JM (typically we only have games at JM)
        var extraFields = [];
        for (g of gamesByDate){
          if(g.fieldNum && g.fieldNum != "" && !(fields.includes(g.fieldNum)) && !(extraFields.includes(g.fieldNum))){
            extraFields.push(g.fieldNum);
          }
        }
        if(extraFields.length > 0)
          fields = fields.concat(extraFields.sort());

        head_row.append(`<th>Times</th>`); // vertial column
        for (f of fields){
          head_row.append(`<th>${f}</th>`);
        }
        
        // $.each(gamesByDate, function(index, gamesGroupedByTime) {
        var index = -1;
        $.each(gamesGroupedByTime, function(time, grouped) {
          // console.log("grouped ", grouped)
          index++;
          body_row[index] = $('<tr/>');
          body_row[index].append('<td>' + grouped[0].time + '</td>');

          for(field of fields){
            const gamesOnField = grouped.filter(v => v.fieldNum == field);
            if (gamesOnField.length > 0){
              var gamesStr = "";
              var classGamesAtSameTime = "";
              // allow for muliple games at the same time & same field
              for(g of gamesOnField){
                // console.log(g['freeholdTeam'])
                let camera = getCamera(cameraSchedule, grouped[0].time, grouped[0].date, field);
                gamesStr += `<span class="${classGamesAtSameTime}">${g.freeholdTeam}(${g.year})${camera}</span>`; 
                classGamesAtSameTime = "sameTimeSameField";
              }
              body_row[index].append(`<td title="vs ${g.opponent} Game# (${g.matchNum})  League (${g.leagueType}) ${g.year}">${gamesStr}</td>`);
            }else{
              body_row[index].append('<td> - </td>');
            }
          }
        });
          
        // seperator
        table_head.append(head_row);
        table_body.append(body_row)
        table.append(table_head);
        table.append(table_body);

        groupByDate.append(table);
        
        $('#testTbl').append(groupByDate);
      }

      function getCamera(cameraSchedule, time, date, field){
        // 2023-04-17T19:15:00
        let currentGameTime = new Date(`${date} ${time}`)
        for(c of cameraSchedule){
          let cameraDateTime = new Date(c['start'])
          if(c['field'].toLowerCase().includes(field.toLowerCase())){

            if( new Date(c['start']).getTime() == currentGameTime.getTime()){
                return ` <span class='${c['camera'].replace(" ", "")}'>(${c['camera']})</span>`
            }
          }
        }
        return ""
      }
        
      function showOldGamesCkbChange(e){
        const {checked} = e.target;

        if (typeof getTestRequest == 'undefined') {
          fetchDataOnLoad();
        }
        else{
          populateTableFromMockData()
        }
      }

    </script>
    <style>
      .pageTitle {
        text-align: center;
      }
      .pageControls{
        text-align: center;
      }
      
      #messageDiv{
        text-align: center;
      }

      .groupedByDate   {
        background-color: #9d9e9f;
        font-size: larger;
        font-weight: bold;
        margin-top: 10px;
        padding: 5px;
      }
      .gamesNotScheduled   {background-color: #ffcc00;}
      /* tr {padding-left: 15px;padding-right: 15px;} */
      table {
        border-collapse: collapse;
        text-align: center;
      }
      th, td {
        border: 1px solid black;
        padding-left: 15px;padding-right: 15px;
      }
      th {font-size: large;}

      .sameTimeSameField{
        background-color: red;
        padding-left: 10px;
      }

      .VEO1{
        background-color: rgb(0, 217, 255);
      }
      .VEO2{
        background-color: rgb(0, 89, 255);
      }
      .VEO3{
        background-color: rgb(21, 126, 82);
      }

    </style>
    
  </head>

  <body>
    <form>
      <div class="pageTitle">
        <h1>
         Freehold Soccer Home Game Schedule
        </h1>
      </div>
      <div class="pageControls">
        <input id="btnFetchFromSheet" type="button" value="Refresh" onclick="fetchDataOnLoad();" />
        <input id="btnFetchFromMock" type="button" value="Load From Test File" onclick="populateTableFromMockData();" />
        <input type="checkbox" id="ckbShowPastGames" onchange="showOldGamesCkbChange(event)"/>
        <label for="ckbMessage">Show games in the past</label>
      </div>
      <div id="messageDiv">
        Hover over the game  to see game details <br />
        For details on cameras contact Dan @ training@freeholdsoccer.com  - (732-522-0263)
      </div>
      <br />
      <br />
      <div id="testTbl"></div>
      <br />
    </form>
  </body>
<!-- HOME FIELDS -->
</html>

